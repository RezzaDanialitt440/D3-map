<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- CSS -->
    <style>
    body {
 background-color:lightgray;;
}
h1, h3, p{
  text-align:center;
}

#scatterplot-stats {
  text-align: center;
}

.axis {
  fill: none;
  stroke: #3A3A3A;
}

.axis text {
  fill: #000;
  stroke: none;
}

circle {
  stroke: #3A3A3A;
}

.cyclist circle:hover {
  cursor: pointer;
}

.tooltip {
  position: absolute;
  padding: 5px;
  box-sizing: border-box;
  background-color: #000;
  color: #fff;
}


    </style>
</head>
<body>

    <!-- DOM -->
    <div>
      <div style="z-index: -1;">
      </div>  
        <div id="scatterplot-stats">    
        </div>
    </div>  

    <!-- JAVASCRIPT -->
    
<script>
        (function() {
  var url = "https://www.nodus-ecosystem.com:3400/getData";
  
  //our JavaScript section starts and the first thing that happens is that we set the size of the area that we’re going to use for the chart and the margins;
  var margin = { top: 60, left: 60, bottom: 60, right: 60 } 
  var height = 480, width = 900;
  //format the time with minutes and seconds
  // var ft = d3.time.format("%M:%S");
  
  //The next section declares the functions linear and scale
  var y = d3.scale.linear().range([0, height]);
  // var x = d3.time.scale().range([0, width]);
  var x = d3.scale.linear().range([0, width]);
  
  //The declarations for our two axes are relatively simple
  //show data (nums) under the x-axis line
  // var xAxis = d3.svg.axis().scale(x).orient("bottom")
  //     .ticks(d3.time.seconds, 30)
      // .tickFormat(ft);
  //show data (nums) left of the y-axis line
  var yAxis = d3.svg.axis().scale(y).orient("left");
  var xAxis = d3.svg.axis().scale(x).orient("bottom");
  

/* 
* The next block of code selects the id scatterplot-stats on the web page 
* and appends an svg object to it of the size 
* that we have set up with our width, height and margin’s.
*/
  var svg = d3.select("#scatterplot-stats").append("svg")
      .attr("height", height + margin.top + margin.bottom)
      .attr("width", width + margin.left + margin.right);
  
  svg.append("rect")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("x", 0)
        .attr("y", 0)
        .attr("fill", "white")
        .attr("fill-opacity", 0);
  // It also adds a g element that provides a reference point for adding our axes.  
  svg = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
  //declair the tooltip
  var tooltip = d3.select("#scatterplot-stats").append("div")
      .attr("class", "tooltip");
  
 
  /*
  * If doping allegiance make the circle red else make it orange
  */
  // function doping(arg) {
  //   return arg !== "" ? "red" : "orange";
  // }
  
  /* 
  * this function is like mouse over. 
  * If we place the mouse over a circle the tooltip is going to show up.
  */
  function showToolTip(d, i) {
    tooltip.style({
      "height": "125px",
      "width": "200px",
      "opacity": 0.9
    });
    var circle = d3.event.target; 
    var tippadding = 5, tipsize = { 
      dx: parseInt(tooltip.style("width")), 
      dy: parseInt(tooltip.style("height")) 
    };
  
    tooltip.style({
        "top": (d3.event.pageY - tipsize.dy - 5) + "px",
        "left": (d3.event.pageX - tipsize.dx - 5) + "px"
      }).html("<span><b>" + d.Tag + ": " + "<br/>" + 
            "X-axis: " + d.x + "<br/>")
  //           "Y-axis: " + d.y + "<br/>");
  }
  
  /* 
  * This function is like mouse out. 
  * If we mouse out then the tooltip is hidding
  */
  function hideToolTip(d, i) {
    tooltip.style({
      "height": 0,
      "width": 0,
      "opacity": 0
    }).html("");
  }
  
  /* 
  * This function is like click. 
  * If we click in the circle we are transfering to another site
  */
  // function openEntry(d) {
  //   if(d.URL) {
  //     var win = window.open(d.URL, "_blank");
  //     win.focus();
  //   }
  // }
  
  /* 
  * d3.json takes the variable url and two more parameters
  * if error, then throw it
  * else map the time-date in the horizontal axis and the rank-position in the verticall axis
  */
  d3.json(url, (error, data) => {
    if(error) {
      throw new Error("d3.json error");
    }
    else {

      // TO SET THE AXIS DYNAMICALLY

      var Xdekat = d3.min(data.map((item) => { return item.x; }));
      var Xjauh = d3.max(data.map((item) => { return item.x; }));
      var Ydekat = d3.min(data.map((item) => { return item.y; }));
      var Yjauh = d3.max(data.map((item) => { return item.y; }));
      // var Xjauh = d3.max(data.x);
      // var Ydekat = d3.min(data.y);
      // var Yjauh = d3.max(data.y);
      // var slowest = d3.max(data.map((item) => { return ft.parse(item.Time); }));
      
      x.domain([Xdekat, Xjauh]);
      y.domain([Yjauh, Ydekat]);
      //Add a "g" element that provides a reference point for adding our axes.
      svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text") //add text to the axis
          .attr("transform", "translate(" + width + ",-30)")
          .attr("dy", "1.8em")
          .attr("text-anchor", "end")
          .text("X-Axis");
      
      svg.append("g")
          .attr("class", "y axis")
          .call(yAxis)
        .append("text") //add text to the axis
          .attr("transform", "rotate(0)")
          .attr("dy", "-0.8em")
          .attr("text-anchor", "end")
          .text("Y-Axis");
      
      /* 
      * we add the cyclists to our scatterplot
      * This block of code creates the cyclists (selectAll(".cyclist")) 
      * and associates each of them with a data set (.data(data)).
      * We then append a circle 
      * with values for x/y position and height/width as configured in our earlier code.
      * we parse the time and the place
      */ 
      var cyclist = svg.selectAll(".cyclist")
          .data(data)
        .enter().append("g")
          .attr("class", "cyclist")
          .attr("x", (d) => { return x(d.x); })
          .attr("y", (d) => { return y(d.y); });
      
      cyclist.append("circle")
          .attr("cx", (d) => { return x(d.x); })
          .attr("cy", (d) => { return y(d.y); })
          .attr("r", 5)
          // .attr("fill", (d) => { return doping(d.Doping); })
          //call the functions
          .on("mouseover", showToolTip)
          .on("mouseout", hideToolTip)
          .on("click", openEntry);
      
      //append the text and fix the distance btw the circles and the names
      // cyclist.append("text")
      //     .attr("x", (d) => { return x(ft.parse(d.Time)) + 7; })
      //     .attr("y", (d) => { return y(d.Place) + 5; })
      //     .text((d) => { return d.Name; });
      
      //right-bottom explainatory text
      // var isDoped = svg.append("g")
      //     .attr("transform", "translate(" + (width - 150) + "," + (height - 100) + ")")
      //     .append("text") 
      //       .attr("x", 10)
      //       .attr("y", 5)
      //       .attr("fill", "red")
      //       .text("* Doping allegiance");;
      // var isNotDoped = svg.append("g")
      //     .attr("transform", "translate(" + (width - 150) + "," + (height - 80) + ")")
      //     .append("text")
      //       .attr("x", 10)
      //       .attr("y", 5)
      //       .attr("fill", "orange")
      //       .text("* No doping allegiance");
    } //end of else
    
  });
}());
    </script>
    
    
</body>
</html>